
/******************************************************************************
 *
 *   FILE
 *   ----
 *   nodeStoreFunctions.c
 *
 *   History
 *   -------
 *   2014-10-21   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_opcua
#define OV_COMPILE_LIBRARY_opcua
#endif



#include "libov/ov_macros.h"
#include "ksbase.h"
#include "opcua.h"
#include "opcua_helpers.h"
#include "NoneTicketAuthenticator.h"
#include "libov/ov_path.h"
#include "libov/ov_memstack.h"

extern OV_INSTPTR_opcua_uaServer opcua_pUaServer;

OV_DLLFNCEXPORT OV_RESULT opcua_nodeStoreFunctions_packCallArgs(
	OV_UINT	numberofArgs,
	const OV_ANY *argList,
	UA_Variant **packedArgList
) {
	OV_UINT iterator = 0;
	UA_StatusCode result;
	*packedArgList = UA_Array_new(numberofArgs, &UA_TYPES[UA_TYPES_VARIANT]);
    if(!(*packedArgList)){
    	return OV_ERR_HEAPOUTOFMEMORY;
    }
    if(*packedArgList == UA_EMPTY_ARRAY_SENTINEL){
    	return OV_ERR_OK;
    }
    for(iterator = 0; iterator < numberofArgs; iterator++){
    	result = ov_AnyToVariant(&(argList[iterator]), &((*packedArgList)[iterator]));
    	if(result != UA_STATUSCODE_GOOD){
    		UA_Array_delete(*packedArgList, numberofArgs, &UA_TYPES[UA_TYPES_VARIANT]);
    		if(result == UA_STATUSCODE_BADOUTOFMEMORY)
    			return OV_ERR_HEAPOUTOFMEMORY;
    		else
    			return OV_ERR_GENERIC;
    	}
    }
	return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_RESULT opcua_nodeStoreFunctions_unpackCallArgs(
	size_t numberofArgs,
	const UA_Variant *packedArgList,
	OV_ANY	**argList
) {
	OV_UINT iterator = 0;
	UA_StatusCode result;

	if(!numberofArgs){
		*argList = NULL;
		return OV_ERR_OK;
	}
	*argList = ov_memstack_alloc(numberofArgs * sizeof(OV_ANY));
	if(!*argList){
		return OV_ERR_HEAPOUTOFMEMORY;
	}
	for(iterator = 0; iterator < numberofArgs; iterator++){
		result = ov_VariantToAny(&(packedArgList[iterator]), &((*argList)[iterator]));
		if(result != UA_STATUSCODE_GOOD){
			if(result == UA_STATUSCODE_BADOUTOFMEMORY)
				return OV_ERR_HEAPOUTOFMEMORY;
			else
				return OV_ERR_GENERIC;
		}
	}
	return OV_ERR_OK;
}

OV_DLLFNCEXPORT UA_StatusCode opcua_nodeStoreFunctions_getCallInputArgs(
	OV_INSTPTR_opcua_methodNode pobj,
	size_t	*numberofArgs,
	UA_Argument	**argList
) {
	OV_UINT iterator = 0;
	if(!numberofArgs || !argList){
		return UA_STATUSCODE_BADINVALIDARGUMENT;
	}
	if(pobj->v_inputNames.veclen != pobj->v_inputTypes.veclen || pobj->v_inputNames.veclen != pobj->v_inputIsArray.veclen
			|| pobj->v_inputNames.veclen != pobj->v_inputLengths.veclen || pobj->v_inputNames.veclen != pobj->v_inputDescriptions.veclen){
		return UA_STATUSCODE_BADNODEATTRIBUTESINVALID;
	}
	*numberofArgs = pobj->v_inputNames.veclen;
	*argList = UA_Array_new(*numberofArgs, &UA_TYPES[UA_TYPES_ARGUMENT]);
	if(!*argList){
		return UA_STATUSCODE_BADOUTOFMEMORY;
	}
	/*	iterate over all argument descriptions	*/
	for(iterator = 0; iterator < *numberofArgs; iterator++){
		/*	name	*/
		(*argList)[iterator].name = UA_String_fromChars(pobj->v_inputNames.value[iterator]);
		if(!(*argList)[iterator].name.data){
			return UA_STATUSCODE_BADOUTOFMEMORY;
		}
		/*	dataType	*/
		(*argList)[iterator].dataType = ov_varTypeToNodeId(pobj->v_inputTypes.value[iterator]);
		/*	ValueRank and Array Dimensions	*/
		if(pobj->v_inputIsArray.value[iterator]){
			(*argList)[iterator].valueRank = 1;
			(*argList)[iterator].arrayDimensionsSize = 1;
			(*argList)[iterator].arrayDimensions = UA_Array_new(1, &UA_TYPES[UA_TYPES_UINT32]);
			if(!(*argList)[iterator].arrayDimensions){
				return UA_STATUSCODE_BADOUTOFMEMORY;
			}
			(*argList)[iterator].arrayDimensions[0] = pobj->v_inputLengths.value[iterator];

		} else {
			(*argList)[iterator].valueRank = -1;
			(*argList)[iterator].arrayDimensionsSize = 0;
		}
		/*	description	*/
		(*argList)[iterator].description.locale = UA_String_fromChars("en");
		if(!(*argList)[iterator].description.locale.data){
			return UA_STATUSCODE_BADOUTOFMEMORY;
		}
		(*argList)[iterator].description.text = UA_String_fromChars(pobj->v_inputDescriptions.value[iterator]);
		if(!(*argList)[iterator].description.text.data){
			return UA_STATUSCODE_BADOUTOFMEMORY;
		}
	}
	return OV_ERR_OK;
}

OV_DLLFNCEXPORT UA_StatusCode opcua_nodeStoreFunctions_getCallOutputArgs(
	OV_INSTPTR_opcua_methodNode pobj,
	size_t	*numberofArgs,
	UA_Argument	**argList
) {
	OV_UINT iterator = 0;
	if(!numberofArgs || !argList){
		return UA_STATUSCODE_BADINVALIDARGUMENT;
	}
	if(pobj->v_outputNames.veclen != pobj->v_outputTypes.veclen || pobj->v_outputNames.veclen != pobj->v_outputIsArray.veclen
			|| pobj->v_outputNames.veclen != pobj->v_outputLengths.veclen || pobj->v_outputNames.veclen != pobj->v_outputDescriptions.veclen){
		return UA_STATUSCODE_BADNODEATTRIBUTESINVALID;
	}
	*numberofArgs = pobj->v_outputNames.veclen;
	*argList = UA_Array_new(*numberofArgs, &UA_TYPES[UA_TYPES_ARGUMENT]);
	if(!*argList){
		return UA_STATUSCODE_BADOUTOFMEMORY;
	}
	/*	iterate over all argument descriptions	*/
	for(iterator = 0; iterator < *numberofArgs; iterator++){
		/*	name	*/
		(*argList)[iterator].name = UA_String_fromChars(pobj->v_outputNames.value[iterator]);
		if(!(*argList)[iterator].name.data){
			return UA_STATUSCODE_BADOUTOFMEMORY;
		}
		/*	dataType	*/
		(*argList)[iterator].dataType = ov_varTypeToNodeId(pobj->v_outputTypes.value[iterator]);
		/*	ValueRank and Array Dimensions	*/
		if(pobj->v_outputIsArray.value[iterator]){
			(*argList)[iterator].valueRank = 1;
			(*argList)[iterator].arrayDimensionsSize = 1;
			(*argList)[iterator].arrayDimensions = UA_Array_new(1, &UA_TYPES[UA_TYPES_UINT32]);
			if(!(*argList)[iterator].arrayDimensions){
				return UA_STATUSCODE_BADOUTOFMEMORY;
			}
			(*argList)[iterator].arrayDimensions[0] = pobj->v_outputLengths.value[iterator];

		} else {
			(*argList)[iterator].valueRank = -1;
			(*argList)[iterator].arrayDimensionsSize = 0;
		}
		/*	description	*/
		(*argList)[iterator].description.locale = UA_String_fromChars("en");
		if(!(*argList)[iterator].description.locale.data){
			return UA_STATUSCODE_BADOUTOFMEMORY;
		}
		(*argList)[iterator].description.text = UA_String_fromChars(pobj->v_outputDescriptions.value[iterator]);
		if(!(*argList)[iterator].description.text.data){
			return UA_STATUSCODE_BADOUTOFMEMORY;
		}
	}
    return OV_ERR_OK;
}

OV_DLLFNCEXPORT UA_Int32 opcua_nodeStoreFunctions_call(
	void *ensHandle,
	const UA_RequestHeader *requestHeader,
	UA_CallMethodRequest *request,
	UA_UInt32 *indices,
	UA_UInt32 indicesSize,
	UA_CallMethodResult *results
) {

	OV_UINT nsIndex = opcua_pUaServer->v_NameSpaceIndex;
	ov_logfile_debug("UA-Call requested in OV-Namespace.");

	return UA_STATUSCODE_BADNOTIMPLEMENTED;
}

